# Agent Instructions for ipfind

This repository contains `ipfind`, a Go-based CLI tool for finding IP addresses and networks within text files or stdin, supporting exact matches, subnets, containing networks, and longest prefix matches.

## Build, Lint, and Test Commands

The project uses `just` as a command runner.

- **Build:** `just build`
  - Runs `gofmt` and builds the binary: `go build -ldflags "-s -w" -o ipfind .`
- **Test All:** `just test`
  - Runs all tests with verbose output: `go test ./... -v`
  - *Note:* Currently, no `_test.go` files exist. Adding them is a high priority.
- **Run Single Test:** `go test -v -run <TestName> ./...`
- **Format Code:** `just fmt`
  - Formats all Go files: `gofmt -w .`
- **Clean:** `just clean`
  - Removes the compiled binary.
- **Run Application (Development):** `go run . <ip> [files...]`
  - Example: `go run . 1.2.3.4 sample.txt -l`

## Project Structure

- `main.go`: Entry point, defines CLI commands and flags using `urfave/cli/v3`.
- `cmd.go`: Core execution logic, file walking, and output formatting.
- `args.go`: Argument parsing, default settings, and logger initialization.
- `parseFile.go`: Logic for processing individual files and applying match criteria (Exact, Subnet, etc.).
- `parseLine.go`: Regex-based IP extraction from text lines.
- `data/`: Contains sample text files for testing and demonstration.
- `TODO.md` & `SUGGESTIONS.md`: Contain planned features, identified bugs, and refactoring ideas.

## Code Style & Conventions

### Language & Tooling
- **Go Version:** 1.25.0+ (as specified in `go.mod`).
- **Formatter:** Always use `gofmt`. Run `just fmt` before committing.
- **Dependencies:** 
  - `github.com/urfave/cli/v3` for CLI handling.
  - `github.com/seancfoley/ipaddress-go` for all IP/Network operations (Tries, Prefix logic).
  - `github.com/charmbracelet/log` for logging.

### Naming Conventions
- **Functions:** Mixture of `camelCase` and `snake_case`. Exported functions must be `UpperCamelCase`.
- **Variables:** Prefer descriptive names, but short names (e.g., `i`, `err`, `dm`) are acceptable in tight scopes.
- **Files:** Use `camelCase.go` or `snake_case.go` (currently a mix).

### Error Handling
- Follow standard Go idioms: `if err != nil { return err }`.
- Use `log.Fatal(err)` only in `main.go` for startup failures.
- Avoid `panic` in production code unless the state is truly unrecoverable. 
- *Note:* There are existing `panic` calls labeled as "lazy" in `cmd.go`; avoid adding more and prefer returning errors.

### Imports
- Group imports: standard library first, followed by a blank line, then external dependencies.
- Use `github.com/charmbracelet/log` for logging instead of the standard library `log` where possible.

### Types and Structs
- Define CLI arguments in `cliArgStruct` (in `args.go`).
- Match results are encapsulated in `dataMatch` (in `parseFile.go`).
- Implement `MarshalJSON` for structs if they contain complex types (like `ipaddr.IPAddress`) that need specific formatting (see `parseFile.go`).

### Matching Logic
- The tool supports multiple match modes: `Exact`, `Subnet`, `Contains`, and `Longest` (LPM).
- `Longest` is the default if no other mode is specified (handled in `argMassage`).
- Use `ipaddr.IPv4AddressTrie` and `ipaddr.IPv6AddressTrie` for efficient matching and storage.

## Best Practices for Agents
1. **IP Comparisons:** Never compare IP strings directly. Always use `ipaddr` objects and their methods (e.g., `.Equal()`, `.Contains()`).
2. **Regex:** When modifying IP extraction, update `parseLine.go`. Note the distinction between `_withSlash` and `_noSlash` regexes.
3. **Concurrency:** When processing large numbers of files, consider using worker pools (planned but not yet fully implemented).
4. **CLI Flags:** When adding new features, register them in `main.go` using `urfave/cli/v3` patterns.
5. **Testing:** Add sample files to `data/` and corresponding tests in `*_test.go` files for any new matching logic. See `SUGGESTIONS.md` for testability improvements.

## AI & Agent Permissions

### Mandatory Permission Rule
Agents must NEVER modify existing source code files (all `.go` files other than `*_test.go`) without explicit, direct permission from the user for each specific change. The AI is a helper, not a replacement.

### Suggestion Workflow
Instead of direct edits, agents must provide suggested changes as diffs or full file content in an external suggestion file (e.g., `SUGGESTIONS.md` or a new file like `REF_ID.suggestion`). 

All such files must include a **Provenance** header:
```markdown
Provenance:
- Generated by AI assistant: opencode
- Model: opencode/gemini-3-flash
- Timestamp: Sat Feb 28 2026
```

### Exceptions
Direct edits/creation are permitted without an intermediate suggestion file ONLY for the following:
- **Test Cases:** Creating or updating `*_test.go` files.
- **Release Tooling:** Creating or updating `goreleaser` configurations (e.g., `.goreleaser.yml`).
Even for these, the user should be informed of the action before or during execution.

## AI & Tool Rules
- This project does not currently have `.cursorrules` or `.github/copilot-instructions.md`.
- Follow the guidelines in this `AGENTS.md` as the primary source of truth for repository-specific standards.
